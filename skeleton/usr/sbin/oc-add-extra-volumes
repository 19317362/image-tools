#!/bin/bash

METADATA_CACHE=`mktemp -u`

include_nbd0=no
[ "$1" = "--include-nbd0" ] && include_nbd0=yes

export PATH="${PATH:+$PATH:}/usr/bin:/bin:/usr/local/bin:/sbin:/usr/sbin:/usr/local/sbin"

if [ -e /usr/sbin/xnbd-client ]; then
    NBD_CLIENT=/usr/sbin/xnbd-client
else
    NBD_CLIENT=/sbin/nbd-client
fi

get_metadata() {
    if [ ! -f $METADATA_CACHE ]; then
        /usr/local/bin/oc-metadata > $METADATA_CACHE
    fi
}

get_value() {
  # Get value from metadata
  key="$1"
  grep "^$key=" "$METADATA_CACHE" | cut -d= -f2 | sed "s/^['\"]//;s/['\"]$//"
}

get_nbd_client_conf() {
  keys=$(get_value VOLUMES)

# Ensure /etc/nbd-client contains KILLALL=false
(cat /etc/nbd-client | grep -v '^KILLALL'; echo KILLALL=false) > /tmp/nbd-client.tmp; mv /tmp/nbd-client.tmp /etc/nbd-client

cat <<EOF
# xnbd.conf - xnbd-register configuration file

# This is the xnbd configuration file. Syntax of this file is semi-structured
# JSON text. Client connections are denoted by "nbdX" objects, where X is
# interpreted as device name, which is supposed to be started. This is, the
# "nbd0" object starts "/dev/nbd0" as configured.
# Similarly, the "server" object, if present starts an xnbd-wrapper super server
# which shares the configured volumes.
# See xnbd-register(8) for a more detailed description about the configuration
# file.

# WARNING: Be careful, only basic syntax validation is performed
#          In particular, xnbd might also accept unfeasible parameters.
#
# This file was generated by /usr/sbin/oc-add-extra-volumes

{
EOF
  for key in $keys; do
    if [ "$include_nbd0" = "no" ]; then
      # Do not include the rootfs in nbd configuration file. It has been mounted
      # from the initramfs, we won't want it to be disconnected when
      # /etc/rc6.d/K34nbd-client is executed.
      test $key -eq 0 && continue
    fi
    cat <<EOF
  "nbd$key": {
    "host": "$(get_value VOLUMES_${key}_EXPORT_URI | sed 's|nbd://\(.*\):.*|\1|')",
    "port": $(get_value VOLUMES_${key}_EXPORT_URI | sed 's|nbd://.*:\(.*\)|\1|')
  },
EOF

  done

cat <<EOF
}
EOF
}

get_metadata
get_nbd_client_conf > /etc/xnbd.conf
tac /etc/xnbd.conf | sed  "2 s/},/}/" | tac > /etc/xnbd.conf.new
mv /etc/xnbd.conf.new /etc/xnbd.conf
rm $METADATA_CACHE

